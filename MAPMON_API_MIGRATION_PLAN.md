# üîÑ **–ü–õ–ê–ù –ú–ò–ì–†–ê–¶–ò–ò MapMon: MQTT ‚Üí API**

## üéØ **–¶–µ–ª—å –º–∏–≥—Ä–∞—Ü–∏–∏**
–£–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π –∏ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –≥–¥–µ frontend –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π API.

---

## üìä **–¢–ï–ö–£–©–ê–Ø –ü–†–û–ë–õ–ï–ú–ê (v0.6)**

### ‚ùå –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π:
```
ESP32 ‚Üí EMQX Cloud MQTT Broker
            ‚Üì
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚Üì                           ‚Üì
üñ•Ô∏è –°–µ—Ä–≤–µ—Ä–Ω—ã–π MQTT           üåê –ë—Ä–∞—É–∑–µ—Ä–Ω—ã–π MQTT
(mqtt-collector.cjs)        (useMqtt.ts)
    ‚Üì                           ‚Üì
üíæ SQLite –ë–∞–∑–∞              üì± Frontend
    ‚Üì
üîó API Server
    ‚Üì
üåê Frontend (—á–µ—Ä–µ–∑ HTTP)
```

### üö® –ü—Ä–æ–±–ª–µ–º—ã:
- **–ò–∑–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å:** –î–≤–∞ –∫–ª–∏–µ–Ω—Ç–∞ –ø–æ–ª—É—á–∞—é—Ç –æ–¥–Ω–∏ –¥–∞–Ω–Ω—ã–µ
- **–ù–∞–≥—Ä—É–∑–∫–∞:** –î–≤–æ–π–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ MQTT –±—Ä–æ–∫–µ—Ä
- **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã:** –í–æ–∑–º–æ–∂–Ω—ã–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—ã client ID
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å:** –°–ª–æ–∂–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

---

## ‚úÖ **–¶–ï–õ–ï–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (v0.7)**

### üéØ –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö:
```
ESP32 ‚Üí EMQX Cloud MQTT Broker
            ‚Üì
    üñ•Ô∏è –¢–û–õ–¨–ö–û –°–µ—Ä–≤–µ—Ä–Ω—ã–π MQTT (mqtt-collector.cjs)
            ‚Üì
    üíæ SQLite –ë–∞–∑–∞ + WebSocket broadcast
            ‚Üì
    üîó API Server (3001) + WebSocket Server
            ‚Üì
    üåê Frontend (API + WebSocket)
```

### üöÄ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:
- **–ï–¥–∏–Ω–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ:** –û–¥–∏–Ω MQTT –∫–ª–∏–µ–Ω—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- **–¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–∞—Ü–∏—è:** –í—Å–µ –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ SQLite
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:** –ú–µ–Ω—å—à–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –±—Ä–æ–∫–µ—Ä
- **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å:** –ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å:** –õ–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

---

## üìã **–ü–õ–ê–ù –î–ï–ô–°–¢–í–ò–ô**

### **–≠–¢–ê–ü 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –ª–æ–∫–∞–ª—å–Ω–æ** ‚úÖ
- [x] –°–∫–∞—á–∞—Ç—å –≤—Å–µ —Ñ–∞–π–ª—ã —Å —Å–µ—Ä–≤–µ—Ä–∞
- [x] –°–æ–∑–¥–∞—Ç—å `composables/useApi.ts`
- [x] –°–æ–∑–¥–∞—Ç—å `app-api.vue` —Å –Ω–æ–≤–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
- [x] –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—É—â—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É

### **–≠–¢–ê–ü 2: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ**
```bash
# 1. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
mv app.vue app-mqtt.vue.backup
mv app-api.vue app.vue

# 2. –ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π dev —Å–µ—Ä–≤–µ—Ä
yarn dev

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É API –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
# Frontend –¥–æ–ª–∂–µ–Ω –ø–æ–ª—É—á–∞—Ç—å –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ /api/telemetry
```

### **–≠–¢–ê–ü 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–Ω–æ–≥–æ API** 
–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ `api-server.cjs`:

```javascript
// –î–æ–±–∞–≤–∏—Ç—å WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
const WebSocket = require('ws');
const wss = new WebSocket.Server({ port: 8080 });

// Broadcast —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º
function broadcastVehicleUpdate(vehicleData) {
    wss.clients.forEach(client => {
        if (client.readyState === WebSocket.OPEN) {
            client.send(JSON.stringify({
                type: 'vehicle_update',
                data: vehicleData
            }));
        }
    });
}
```

### **–≠–¢–ê–ü 4: –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**
```bash
# 1. –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã –Ω–∞ —Å–µ—Ä–≤–µ—Ä
scp composables/useApi.ts root@147.45.213.22:/var/www/mapmon/composables/
scp app.vue root@147.45.213.22:/var/www/mapmon/

# 2. –û–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—ã–π API
# –î–æ–±–∞–≤–∏—Ç—å WebSocket –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ api-server.cjs

# 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–∏—Å—ã
pm2 restart mapmon
pm2 restart mapmon-api

# 4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É
curl http://localhost:3001/api/status
```

### **–≠–¢–ê–ü 5: –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ frontend –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç ESP32
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
- [ ] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- [ ] –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ MQTT –∫–ª–∏–µ–Ω—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ –æ—Ç–∫–ª—é—á–µ–Ω

---

## üîß **–¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –î–ï–¢–ê–õ–ò**

### **–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è:**
1. **`app.vue`** - –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ API –≤–µ—Ä—Å–∏—é
2. **`composables/useApi.ts`** - –Ω–æ–≤—ã–π API –∫–ª–∏–µ–Ω—Ç  
3. **`server/api-server.cjs`** - –¥–æ–±–∞–≤–∏—Ç—å WebSocket
4. **`components/MapComponent.vue`** - –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å

### **API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π):**
- `GET /api/status` - —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–µ—Ä–∞
- `GET /api/vehicles` - —Å–ø–∏—Å–æ–∫ —Ç–µ—Ö–Ω–∏–∫–∏
- `GET /api/telemetry` - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
- `GET /api/telemetry/latest` - —Ç–æ –∂–µ —á—Ç–æ telemetry

### **–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**
- **WebSocket:** `ws://fleetmonitor.ru:8080` –¥–ª—è real-time
- **Polling:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ:** –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–∞—Ö —Å–≤—è–∑–∏

---

## üéØ **–†–ï–ó–£–õ–¨–¢–ê–¢ –ú–ò–ì–†–ê–¶–ò–ò**

### ‚úÖ **–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏:**
- Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ API
- –£–±—Ä–∞–Ω –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π MQTT –∫–ª–∏–µ–Ω—Ç
- –û–¥–∏–Ω MQTT –∫–ª–∏–µ–Ω—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ —Å ESP32 –¥–∞–Ω–Ω—ã–º–∏
- WebSocket –¥–ª—è real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π

### üìä **–ù–æ–≤–∞—è –≤–µ—Ä—Å–∏—è: MapMon v0.7**
- –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: –°–µ—Ä–≤–µ—Ä–Ω—ã–π API + WebSocket
- MQTT: –¢–æ–ª—å–∫–æ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–ª–ª–µ–∫—Ç–æ—Ä
- Frontend: API-–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π
- –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞

---

## üìù **–ö–û–ú–ê–ù–î–´ –î–õ–Ø –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø**

### 1. –†–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ:
```bash
ssh root@147.45.213.22
cd /var/www/mapmon
cp app.vue app-mqtt.vue.backup
cp composables/useMqtt.ts composables/useMqtt.ts.backup
```

### 2. –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤:
```bash
scp app-api.vue root@147.45.213.22:/var/www/mapmon/app.vue
scp composables/useApi.ts root@147.45.213.22:/var/www/mapmon/composables/
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫:
```bash
ssh root@147.45.213.22
cd /var/www/mapmon
pm2 restart mapmon
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞:
```bash
curl https://fleetmonitor.ru/api/status
# –î–æ–ª–∂–µ–Ω –≤–µ—Ä–Ω—É—Ç—å: {"status":"API Server running with SQLite","database":"connected"}
```

---

**üìÖ –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 17 –∏—é–Ω—è 2025  
**üè∑Ô∏è –¶–µ–ª—å:** –ü–µ—Ä–µ—Ö–æ–¥ —Å v0.6 –Ω–∞ v0.7  
**‚ö° –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π (—É–±—Ä–∞—Ç—å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ MQTT) 