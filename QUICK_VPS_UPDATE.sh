#!/bin/bash

# ๐ ะะซะกะขะะะ ะะะะะะะะะะ MAPMON VPS - ะะกะะะะะะะะะฏ MQTT ะะขะะะะงะะะ
# ะัะฟะพะปะฝะธัั ะฝะฐ ัะตัะฒะตัะต: bash QUICK_VPS_UPDATE.sh

echo "๐ง ะะฐัะธะฝะฐั ะพะฑะฝะพะฒะปะตะฝะธะต MapMon VPS..."
echo "๐ ะขะตะบััะฐั ะดะธัะตะบัะพัะธั: $(pwd)"

# ะัะพะฒะตัะบะฐ ััะพ ะผั ะฒ ะฟัะฐะฒะธะปัะฝะพะน ะดะธัะตะบัะพัะธะธ
if [[ ! -f "package.json" ]]; then
    echo "โ ะัะธะฑะบะฐ: ะฝะต ะฝะฐะนะดะตะฝ package.json"
    echo "๐ ะะตัะตัะพะดะธะผ ะฒ /var/www/mapmon"
    cd /var/www/mapmon
fi

echo "๐ 1. ะััะฐะฝะพะฒะบะฐ PM2 ะฟัะพัะตััะพะฒ..."
pm2 stop ecosystem.config.cjs

echo "๐ฅ 2. ะะพะปััะตะฝะธะต ะธัะฟัะฐะฒะปะตะฝะธะน ะธะท GitHub..."
git pull origin master

echo "๐ฆ 3. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน..."
yarn install --production

echo "๐จ 4. ะะตัะตัะฑะพัะบะฐ ะฟัะพะตะบัะฐ..."
yarn build

echo "๐ 5. ะะตัะตะทะฐะฟััะบ ัะตัะฒะธัะพะฒ..."
pm2 restart ecosystem.config.cjs

echo "๐ 6. ะัะพะฒะตัะบะฐ ััะฐัััะฐ..."
pm2 status

echo "๐ 7. ะะพัะปะตะดะฝะธะต ะปะพะณะธ..."
pm2 logs --lines 10

echo ""
echo "โ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะตััะตะฝะพ!"
echo "๐ ะัะพะฒะตัััะต: https://fleetmonitor.ru/history"
echo "๐ญ MQTT ะพัะปะฐะดัะธะบ ะดะพะปะถะตะฝ ัะฐะฑะพัะฐัั ะฒ ะดะตะผะพ ัะตะถะธะผะต"
echo ""
echo "๐ ะะพะปะฝัะต ะธะฝััััะบัะธะธ: VPS_MQTT_DEBUGGER_UPDATE.md" 