# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ MQTT —Ç–æ–ø–∏–∫–æ–≤ MapMon v0.6

## üìã **–û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–æ–ø–∏–∫–æ–≤:**

```
mapmon/
‚îú‚îÄ‚îÄ fleet/                          # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä–∫–æ–º
‚îÇ   ‚îú‚îÄ‚îÄ discovery                   # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
‚îÇ   ‚îú‚îÄ‚îÄ status                      # –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
‚îÇ   ‚îî‚îÄ‚îÄ commands                    # –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
‚îú‚îÄ‚îÄ vehicles/                       # –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îÇ   ‚îî‚îÄ‚îÄ {vehicle_id}/              # ID –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îÇ       ‚îú‚îÄ‚îÄ data/                   # –î–∞–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ telemetry          # –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ gps                # GPS –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–≤—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã–µ)
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ sensors            # –î–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ diagnostics        # –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ
‚îÇ       ‚îú‚îÄ‚îÄ status/                # –°—Ç–∞—Ç—É—Å—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ connection         # –°—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ health             # –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ battery            # –°—Ç–∞—Ç—É—Å –±–∞—Ç–∞—Ä–µ–∏
‚îÇ       ‚îú‚îÄ‚îÄ control/               # –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ commands           # –ö–æ–º–∞–Ω–¥—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ config             # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ firmware           # –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—à–∏–≤–∫–∏
‚îÇ       ‚îî‚îÄ‚îÄ alerts/                # –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ —Ç—Ä–µ–≤–æ–≥–∏
‚îÇ           ‚îú‚îÄ‚îÄ critical           # –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
‚îÇ           ‚îú‚îÄ‚îÄ warnings           # –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
‚îÇ           ‚îî‚îÄ‚îÄ info               # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
‚îî‚îÄ‚îÄ system/                         # –°–∏—Å—Ç–µ–º–Ω—ã–µ —Ç–æ–ø–∏–∫–∏
    ‚îú‚îÄ‚îÄ logs                        # –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
    ‚îú‚îÄ‚îÄ metrics                     # –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
    ‚îî‚îÄ‚îÄ heartbeat                   # –°–∏—Å—Ç–µ–º–Ω—ã–π heartbeat
```

## üöú **–¢–æ–ø–∏–∫–∏ –¥–ª—è ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**

### **–ò—Å—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ (ESP32 ‚Üí –°–µ—Ä–≤–µ—Ä):**
- `mapmon/vehicles/{vehicle_id}/data/telemetry` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è (5 —Å–µ–∫)
- `mapmon/vehicles/{vehicle_id}/data/gps` - GPS –¥–∞–Ω–Ω—ã–µ (1-2 —Å–µ–∫ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏)
- `mapmon/vehicles/{vehicle_id}/data/sensors` - –¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤ (10 —Å–µ–∫)
- `mapmon/vehicles/{vehicle_id}/status/connection` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `mapmon/vehicles/{vehicle_id}/status/health` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã (30 —Å–µ–∫)
- `mapmon/vehicles/{vehicle_id}/alerts/critical` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `mapmon/vehicles/{vehicle_id}/alerts/warnings` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### **–í—Ö–æ–¥—è—â–∏–µ –∫–æ–º–∞–Ω–¥—ã (–°–µ—Ä–≤–µ—Ä ‚Üí ESP32):**
- `mapmon/vehicles/{vehicle_id}/control/commands` - –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `mapmon/vehicles/{vehicle_id}/control/config` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
- `mapmon/fleet/commands` - –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

## üñ•Ô∏è **–¢–æ–ø–∏–∫–∏ –¥–ª—è —Å–µ—Ä–≤–µ—Ä–∞:**

### **–ü–æ–¥–ø–∏—Å–∫–∏ (–≤—Ö–æ–¥—è—â–∏–µ):**
- `mapmon/vehicles/+/data/+` - –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `mapmon/vehicles/+/status/+` - –≤—Å–µ —Å—Ç–∞—Ç—É—Å—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- `mapmon/vehicles/+/alerts/+` - –≤—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `mapmon/fleet/discovery` - –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –Ω–æ–≤—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### **–ü—É–±–ª–∏–∫–∞—Ü–∏–∏ (–∏—Å—Ö–æ–¥—è—â–∏–µ):**
- `mapmon/fleet/status` - –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
- `mapmon/vehicles/{vehicle_id}/control/commands` - –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
- `mapmon/system/metrics` - –º–µ—Ç—Ä–∏–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞

## üìä **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ–±—â–µ–Ω–∏–π:**

### **–¢–µ–ª–µ–º–µ—Ç—Ä–∏—è (telemetry):**
```json
{
  "timestamp": 1720012345678,
  "vehicle_id": "ESP32_Car_2046",
  "location": {
    "lat": 55.75580,
    "lng": 37.61760,
    "altitude": 156.5,
    "accuracy": 3.2
  },
  "motion": {
    "speed": 25.3,
    "heading": 135.7,
    "acceleration": 0.8
  },
  "engine": {
    "rpm": 2450,
    "status": "active",
    "load": 65.2
  },
  "power": {
    "battery": 84.5,
    "voltage": 12.6,
    "current": 2.3
  },
  "environment": {
    "temperature": 24.1,
    "humidity": 62.3
  }
}
```

### **GPS –¥–∞–Ω–Ω—ã–µ (–≤—ã—Å–æ–∫–æ—á–∞—Å—Ç–æ—Ç–Ω—ã–µ):**
```json
{
  "timestamp": 1720012345678,
  "vehicle_id": "ESP32_Car_2046",
  "lat": 55.75580,
  "lng": 37.61760,
  "speed": 25.3,
  "heading": 135.7
}
```

### **–°—Ç–∞—Ç—É—Å –∑–¥–æ—Ä–æ–≤—å—è (health):**
```json
{
  "timestamp": 1720012345678,
  "vehicle_id": "ESP32_Car_2046",
  "system": {
    "uptime": 86400,
    "free_memory": 234567,
    "cpu_usage": 45.2,
    "wifi_rssi": -45,
    "mqtt_reconnects": 0
  },
  "sensors": {
    "gps_fix": true,
    "temperature_sensor": "ok",
    "battery_sensor": "ok"
  },
  "alerts_count": {
    "critical": 0,
    "warnings": 1,
    "info": 3
  }
}
```

### **–ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:**
```json
{
  "timestamp": 1720012345678,
  "command": "start_engine",
  "parameters": {
    "target_rpm": 1500,
    "duration": 300
  },
  "priority": "normal",
  "timeout": 30
}
```

## üîß **QoS —É—Ä–æ–≤–Ω–∏:**

### **QoS 0 (At most once):**
- `data/gps` - GPS –¥–∞–Ω–Ω—ã–µ (—á–∞—Å—Ç—ã–µ, –ø–æ—Ç–µ—Ä—è –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–∞)
- `data/sensors` - –¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
- `system/metrics` - –º–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

### **QoS 1 (At least once):**
- `data/telemetry` - –æ—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è
- `status/health` - —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è
- `alerts/warnings` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è

### **QoS 2 (Exactly once):**
- `control/commands` - –∫–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
- `alerts/critical` - –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
- `status/connection` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

## üè∑Ô∏è **Retained —Å–æ–æ–±—â–µ–Ω–∏—è:**

### **–í—Å–µ–≥–¥–∞ Retained:**
- `status/connection` - –ø–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `status/health` - –ø–æ—Å–ª–µ–¥–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–¥–æ—Ä–æ–≤—å—è
- `fleet/status` - –æ–±—â–∏–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã

### **–ù–∏–∫–æ–≥–¥–∞ Retained:**
- `data/gps` - GPS –¥–∞–Ω–Ω—ã–µ (—É—Å—Ç–∞—Ä–µ–≤–∞—é—Ç –±—ã—Å—Ç—Ä–æ)
- `data/sensors` - –¥–∞–Ω–Ω—ã–µ –¥–∞—Ç—á–∏–∫–æ–≤
- `control/commands` - –∫–æ–º–∞–Ω–¥—ã (–≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑)

## üîç **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è:**

### **Frontend –ø–æ–¥–ø–∏—Å–∫–∏:**
```javascript
// –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
'mapmon/vehicles/+/data/telemetry'
'mapmon/vehicles/+/status/connection'
'mapmon/vehicles/+/alerts/critical'
'mapmon/fleet/status'
```

### **Analytics –ø–æ–¥–ø–∏—Å–∫–∏:**
```javascript
// –í—Å–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
'mapmon/vehicles/+/data/+'
'mapmon/vehicles/+/status/+'
'mapmon/system/metrics'
```

### **Alerting –ø–æ–¥–ø–∏—Å–∫–∏:**
```javascript
// –¢–æ–ª—å–∫–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
'mapmon/vehicles/+/alerts/+'
'mapmon/system/logs'
```

## üìà **–ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**

### **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ:**
- –ö–∞–∂–¥–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π `vehicle_id`
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –±–µ–∑ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
- –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏ –ø–æ —Ç–æ–ø–∏–∫–∞–º

### **–ì–µ–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ:**
```
mapmon/region/{region_code}/vehicles/{vehicle_id}/...
```

### **–¢–∏–ø—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤:**
```
mapmon/vehicles/{vehicle_id}/type/{device_type}/...
# device_type: tractor, harvester, truck, sensor_node
```

## üõ°Ô∏è **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å —Ç–æ–ø–∏–∫–æ–≤:**

### **ACL (Access Control Lists):**
```
# ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (—Ç–æ–ª—å–∫–æ –ø—É–±–ª–∏–∫–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö):
u_DEVICE_001: pub mapmon/vehicles/ESP32_Car_2046/data/+
u_DEVICE_001: pub mapmon/vehicles/ESP32_Car_2046/status/+
u_DEVICE_001: pub mapmon/vehicles/ESP32_Car_2046/alerts/+
u_DEVICE_001: sub mapmon/vehicles/ESP32_Car_2046/control/+

# –°–µ—Ä–≤–µ—Ä (–ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø):
u_MZEPA5: pub mapmon/+
u_MZEPA5: sub mapmon/+

# Frontend (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö):
u_FRONTEND: sub mapmon/vehicles/+/data/+
u_FRONTEND: sub mapmon/vehicles/+/status/+
u_FRONTEND: sub mapmon/fleet/status
```

## üì¶ **–û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:**

–°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å—Ç–∞—Ä—ã—Ö —Ç–æ–ø–∏–∫–æ–≤:
- `car` ‚Üí `mapmon/vehicles/{vehicle_id}/data/telemetry`
- `vehicles/{id}/telemetry` ‚Üí `mapmon/vehicles/{id}/data/telemetry`
- `vehicles/{id}/status` ‚Üí `mapmon/vehicles/{id}/status/connection`
- `vehicles/{id}/heartbeat` ‚Üí `mapmon/vehicles/{id}/status/health`