# ๐ MapMon Server v0.7 - API ะััะธัะตะบัััะฐ

> **โ๏ธ ะะ ะะะะะะขะะะะะะขะฌ ะญะขะะข ะคะะะ!** ะขะพะปัะบะพ ะบะพะฟะธัะพะฒะฐัั ะดะปั ัะพะทะดะฐะฝะธั ะฝะพะฒะพะน ะฒะตััะธะธ.

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 17 ะธัะฝั 2025  
**ะัะฝะพะฒะฝัะต ะธะทะผะตะฝะตะฝะธั:** ะฃะฑัะฐะฝะพ ะดัะฑะปะธัะพะฒะฐะฝะธะต MQTT, ะฟะตัะตัะพะด ะฝะฐ API ะฐััะธัะตะบัััั

---

## ๐๏ธ ะััะธัะตะบัััะฐ ัะตัะฒะตัะฐ

### ๐ฅ๏ธ ะกะตัะฒะตั
- **IP:** 147.45.213.22
- **ะะพะผะตะฝ:** fleetmonitor.ru (ั SSL)
- **OS:** Ubuntu 22.04
- **ะะตััััั:** 1 CPU, 2GB RAM, 30GB NVMe

### ๐ง ะฃััะฐะฝะพะฒะปะตะฝะฝัะต ัะตัะฒะธัั
- **Node.js:** v20 LTS
- **PM2:** ะฃะฟัะฐะฒะปะตะฝะธะต ะฟัะพัะตััะฐะผะธ
- **Nginx:** Reverse proxy + SSL (Let's Encrypt)
- **SQLite3:** ะะฐะทะฐ ะดะฐะฝะฝัั
- **better-sqlite3:** Node.js ะดัะฐะนะฒะตั

---

## ๐ ะััะธัะตะบัััะฐ ะฟัะธะปะพะถะตะฝะธั

### ๐ PM2 ะัะพัะตััั
```
โโโโโโโฌโโโโโโโโโโโโโโโโโโฌโโโโโโโโโฌโโโโโโฌโโโโโโโโโโโฌโโโโโโโโโโฌโโโโโโโโโโโ
โ id  โ name            โ mode   โ โบ   โ status   โ cpu     โ memory   โ
โโโโโโโผโโโโโโโโโโโโโโโโโโผโโโโโโโโโผโโโโโโผโโโโโโโโโโโผโโโโโโโโโโผโโโโโโโโโโโค
โ 3   โ mapmon          โ fork   โ 0   โ online   โ 0%      โ 80.4mb   โ
โ 1   โ mapmon-api      โ fork   โ 1   โ online   โ 0%      โ 60.2mb   โ
โ 4   โ mqtt-collector  โ fork   โ 0   โ online   โ 0%      โ 55mb     โ
โโโโโโโดโโโโโโโโโโโโโโโโโโดโโโโโโโโโดโโโโโโดโโโโโโโโโโโดโโโโโโโโโโดโโโโโโโโโโโ
```

**1. mapmon (Frontend):**
- **ะะพะผะฐะฝะดะฐ:** `yarn dev --host 0.0.0.0 --port 3000`
- **ะะฐะทะฝะฐัะตะฝะธะต:** Nuxt 3 ะฟัะธะปะพะถะตะฝะธะต ั API ะบะปะธะตะฝัะพะผ
- **ะะพัั:** 3000

**2. mapmon-api (Backend API):**
- **ะคะฐะนะป:** `/var/www/mapmon/server/api-server.cjs`
- **ะะพัั:** 3001

**3. mqtt-collector (MQTT ะบะปะธะตะฝั):**
- **ะคะฐะนะป:** `/var/www/mapmon/server/mqtt-collector.cjs`

---

## ๐ ะะพัะพะบ ะดะฐะฝะฝัั

### โ **ะะะะะฏ ะะะฅะะขะะะขะฃะะ v0.7:**
```
ESP32 โ EMQX Cloud MQTT
         โ
๐ฅ๏ธ ะกะตัะฒะตัะฝัะน MQTT ะบะพะปะปะตะบัะพั (mqtt-collector.cjs)
         โ
๐พ SQLite ะฑะฐะทะฐ ะดะฐะฝะฝัั
         โ
๐ API ัะตัะฒะตั (api-server.cjs:3001)
         โ
๐ Frontend ั API ะบะปะธะตะฝัะพะผ (useApi.ts)
```

### โ **ะฃะะะะะ ะธะท v0.6:**
- **ะัะฐัะทะตัะฝัะน MQTT ะบะปะธะตะฝั** (useMqtt.ts) - ะฑะพะปััะต ะฝะต ะธัะฟะพะปัะทัะตััั
- **ะัะฑะปะธัะพะฒะฐะฝะธะต ะฟะพะดะบะปััะตะฝะธะน** ะบ EMQX Cloud
- **ะะพะฝัะปะธะบัั client ID** ะฟัะธ ะผะฝะพะถะตััะฒะตะฝะฝัั ะฟะพะดะบะปััะตะฝะธัั

---

## ๐๏ธ ะะฐะทะฐ ะดะฐะฝะฝัั SQLite

### ๐ ะะฐัะฟะพะปะพะถะตะฝะธะต
- **ะคะฐะนะป:** `/var/www/mapmon/sqlite/mapmon.db`
- **ะกัะตะผะฐ:** `/var/www/mapmon/sqlite/schema.sql`
- **ะะตะฝะตะดะถะตั:** `/var/www/mapmon/sqlite/SQLiteManager.cjs`

### ๐ ะกัััะบัััะฐ ัะฐะฑะปะธั
```sql
CREATE TABLE IF NOT EXISTS vehicles (
    id TEXT PRIMARY KEY, 
    name TEXT NOT NULL
);

CREATE TABLE IF NOT EXISTS telemetry (
    id INTEGER PRIMARY KEY AUTOINCREMENT, 
    vehicle_id TEXT, 
    timestamp INTEGER, 
    lat REAL, 
    lng REAL, 
    speed REAL, 
    battery REAL
);
```

---

## ๐ API ะญะฝะดะฟะพะธะฝัั

**ะะฐะทะฐ:** http://localhost:3001/api/

```
GET /api/status           - ะกัะฐััั API ะธ ะะ
GET /api/vehicles         - ะกะฟะธัะพะบ ะฒัะตะน ัะตัะฝะธะบะธ
GET /api/telemetry        - ะะพัะปะตะดะฝะธะต 100 ะทะฐะฟะธัะตะน
GET /api/telemetry/latest - ะขะพ ะถะต ััะพ /api/telemetry
```

---

## ๐ก MQTT ะะพะฝัะธะณััะฐัะธั

### ๐ EMQX Cloud (ัะพะปัะบะพ ัะตัะฒะตัะฝัะน ะบะปะธะตะฝั)
- **URL:** `wss://o0acf6a7.ala.dedicated.gcp.emqxcloud.com:8084/mqtt`
- **Username:** `iforza`
- **Password:** `iforza`
- **Client ID:** `mapmon-server-` + timestamp

### ๐ ะขะพะฟะธะบะธ
```
- car
- vehicles/+/telemetry  
- vehicles/+/status
- vehicles/+/heartbeat
```

---

## ๐ง Frontend ะธะทะผะตะฝะตะฝะธั

### ๐ ะะพะฒัะต ัะฐะนะปั
- **`composables/useApi.ts`** - API ะบะปะธะตะฝั ะฒะผะตััะพ MQTT
- **ะะฑะฝะพะฒะปะตะฝะฝัะน `app.vue`** - ะธะฝัะตััะตะนั ั API ะฐััะธัะตะบัััะพะน

### ๐ ะะฐะบ ัะฐะฑะพัะฐะตั Frontend
1. **ะะฝะธัะธะฐะปะธะทะฐัะธั:** `useApi().initialize()`
2. **ะะพะปััะตะฝะธะต ะดะฐะฝะฝัั:** HTTP ะทะฐะฟัะพัั ะบ `/api/telemetry`
3. **Real-time ะพะฑะฝะพะฒะปะตะฝะธั:** Polling ะบะฐะถะดัะต 5 ัะตะบัะฝะด
4. **WebSocket:** ะะพะดะณะพัะพะฒะปะตะฝะพ ะดะปั ะฑัะดััะตะณะพ real-time

### ๐ ะะฝัะตััะตะนั
- **ะะบะปะฐะดะบะฐ "ะขะตัะฝะธะบะฐ":** ะกะฟะธัะพะบ ESP32 ััััะพะนััะฒ
- **ะะบะปะฐะดะบะฐ "API":** ะกัะฐััั ัะตัะฒะตัะฝะพะณะพ API, ะฐััะธัะตะบัััะฐ
- **ะะบะปะฐะดะบะฐ "ะะฝะฐะปะธัะธะบะฐ":** ะกัะฐัะธััะธะบะฐ (ะฟะพะดะณะพัะพะฒะปะตะฝะพ)

---

## ๐ ะะปััะตะฒัะต ะธะทะผะตะฝะตะฝะธั ะฒ v0.7

### โ ะฃะดะฐะปะตะฝะพ
- **ะัะฐัะทะตัะฝัะน MQTT ะบะปะธะตะฝั** - ะฟะพะปะฝะพัััั ัะฑัะฐะฝ
- **useMqtt.ts** - ะฑะพะปััะต ะฝะต ะธัะฟะพะปัะทัะตััั ะฒ frontend
- **ะัะฑะปะธัะพะฒะฐะฝะธะต MQTT ะฟะพะดะบะปััะตะฝะธะน**
- **MQTT ะทะฐะฒะธัะธะผะพััั** ะธะท package.json frontend

### โ ะะพะฑะฐะฒะปะตะฝะพ  
- **useApi.ts** - ะฝะพะฒัะน API ะบะปะธะตะฝั
- **API ะฐััะธัะตะบัััะฐ** ะฒ app.vue
- **ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝัะน ะฟะพัะพะบ ะดะฐะฝะฝัั** ัะตัะตะท ัะตัะฒะตั
- **Polling ะผะตัะฐะฝะธะทะผ** ะดะปั ะพะฑะฝะพะฒะปะตะฝะธะน

### ๐ง ะัะฟัะฐะฒะปะตะฝะพ
- **ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั:** ะะตะฝััะต ะฝะฐะณััะทะบะธ ะฝะฐ MQTT ะฑัะพะบะตั
- **ะกัะฐะฑะธะปัะฝะพััั:** ะะดะธะฝ ะธััะพัะฝะธะบ ะดะฐะฝะฝัั
- **ะะฐัััะฐะฑะธััะตะผะพััั:** ะะตะณะบะพ ะดะพะฑะฐะฒะปััั ะฝะพะฒัั ะบะปะธะตะฝัะพะฒ

---

## ๐ฏ ะกัะฐััั ัะฐะฑะพัั

### โ ะงัะพ ัะฐะฑะพัะฐะตั
- **Frontend:** https://fleetmonitor.ru (ั API ะบะปะธะตะฝัะพะผ)
- **MQTT:** ะขะพะปัะบะพ ัะตัะฒะตัะฝัะน ะบะพะปะปะตะบัะพั ะฟะพะปััะฐะตั ะดะฐะฝะฝัะต
- **SQLite:** ะฆะตะฝััะฐะปะธะทะพะฒะฐะฝะฝะพะต ััะฐะฝะตะฝะธะต ะดะฐะฝะฝัั
- **API:** ะัะดะฐะตั ะดะฐะฝะฝัะต frontend ัะตัะตะท HTTP

### ๐ ะฃะปัััะตะฝะธั
- **ะะตะฝััะต ะฟะพะดะบะปััะตะฝะธะน:** 1 MQTT ะบะปะธะตะฝั ะฒะผะตััะพ 2
- **ะะฐะดะตะถะฝะพััั:** ะััะธัะพะฒะฐะฝะธะต ะฒ SQLite
- **ะัะพััะพัะฐ:** ะะดะธะฝ ะฟะพัะพะบ ะดะฐะฝะฝัั
- **ะัะทัะฒัะธะฒะพััั:** Polling ะบะฐะถะดัะต 5 ัะตะบัะฝะด

---

## ๐ Nginx ะบะพะฝัะธะณััะฐัะธั

### ๐ ะัะพะบัะธ (ะฑะตะท ะธะทะผะตะฝะตะฝะธะน)
```nginx
# Frontend
location / {
    proxy_pass http://127.0.0.1:3000;
}

# API
location /api/ {
    proxy_pass http://127.0.0.1:3001;
}
```

---

## ๐ ะะพะผะฐะฝะดั ัะฐะทะฒะตัััะฒะฐะฝะธั v0.7

### 1. Git ะพะฑะฝะพะฒะปะตะฝะธะต:
```bash
cd /var/www/mapmon
git pull origin master
```

### 2. ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน:
```bash
yarn install
```

### 3. ะะตัะตะทะฐะฟััะบ:
```bash
pm2 restart mapmon
```

### 4. ะัะพะฒะตัะบะฐ:
```bash
curl https://fleetmonitor.ru/api/status
# {"status":"API Server running with SQLite","database":"connected"}
```

---

## ๐ ะกัะฐะฒะฝะตะฝะธะต ะฒะตััะธะน

| ะัะฟะตะบั | v0.6 (MQTT ะดัะฑะปะธัะพะฒะฐะฝะธะต) | v0.7 (API ะฐััะธัะตะบัััะฐ) |
|--------|---------------------------|-------------------------|
| MQTT ะบะปะธะตะฝัั | 2 (ัะตัะฒะตั + ะฑัะฐัะทะตั) | 1 (ัะพะปัะบะพ ัะตัะฒะตั) |
| ะััะพัะฝะธะบ ะดะฐะฝะฝัั | MQTT + SQLite | ะขะพะปัะบะพ SQLite ัะตัะตะท API |
| ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั | ะะทะฑััะพัะฝะพััั | ะะฟัะธะผะธะทะธัะพะฒะฐะฝะฐ |
| ะกะปะพะถะฝะพััั | ะััะพะบะฐั | ะฃะฟัะพัะตะฝะฐ |
| ะะฐะดะตะถะฝะพััั | ะะพะฝัะปะธะบัั ะฒะพะทะผะพะถะฝั | ะกัะฐะฑะธะปัะฝะฐั |

---

**๐ ะะฐัะฐ:** 17 ะธัะฝั 2025  
**๐ท๏ธ ะะตััะธั:** MapMon v0.7  
**โ ะกัะฐััั:** API ะฐััะธัะตะบัััะฐ ะฑะตะท ะดัะฑะปะธัะพะฒะฐะฝะธั MQTT** 