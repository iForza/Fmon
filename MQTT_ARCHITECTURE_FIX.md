# üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–´ MQTT –í MAPMON v0.5

## üìã –ê–ù–ê–õ–ò–ó –ü–†–û–ë–õ–ï–ú

### ‚úÖ **–†–ï–®–ï–ù–ù–´–ï –ü–†–û–ë–õ–ï–ú–´:**

#### **–ü—Ä–æ–±–ª–µ–º–∞ 4: ecosystem.config.cjs**
- ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: –°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π ecosystem.config.cjs –¥–ª—è PM2
- üìÅ **–§–∞–π–ª**: `ecosystem.config.cjs`
- üîÑ **–û—Ç–∫–∞—Ç**: `rm ecosystem.config.cjs`

#### **–ü—Ä–æ–±–ª–µ–º–∞ 8: MQTT API endpoints**  
- ‚úÖ **–ò–°–ü–†–ê–í–õ–ï–ù–û**: –î–æ–±–∞–≤–ª–µ–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫ —Ä–µ–∞–ª—å–Ω–æ–º—É API —Å–µ—Ä–≤–µ—Ä—É
- üìÅ **–§–∞–π–ª—ã**: `server/index.ts`, `server-backup/api-server.cjs`, `server-backup/mqtt-collector.cjs`
- üîÑ **–û—Ç–∫–∞—Ç**: `git checkout HEAD~3`

### üî¥ **–ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê: –ü—Ä–æ—Ç–æ–∫–æ–ª—ã ESP32 ‚Üî –í–µ–±**

**–¢–µ–∫—É—â–∞—è —Å–∏—Ç—É–∞—Ü–∏—è:**
- **ESP32**: TCP MQTT (–ø–æ—Ä—Ç 1883) + PubSubClient –±–∏–±–ª–∏–æ—Ç–µ–∫–∞
- **–í–µ–±**: WebSocket MQTT (–ø–æ—Ä—Ç 8084) + MQTT.js
- **–°–µ—Ä–≤–µ—Ä**: MQTT –∫–æ–ª–ª–µ–∫—Ç–æ—Ä TCP (–ø–æ—Ä—Ç 1883) ‚úÖ –†–ê–ë–û–¢–ê–ï–¢

**–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–Ø**: –û—Å—Ç–∞–≤–∏—Ç—å ESP32 –Ω–∞ TCP, —É–ª—É—á—à–∏—Ç—å —Å–µ—Ä–≤–µ—Ä–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É

---

## üèóÔ∏è –ù–û–í–ê–Ø –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –°–ò–°–¢–ï–ú–´

```
ESP32 Devices
     ‚Üì TCP MQTT (1883)
EMQX Cloud Broker
     ‚Üì WebSocket MQTT (8084)  
MQTT Collector (server-backup/mqtt-collector.cjs)
     ‚Üì HTTP API
API Server (server-backup/api-server.cjs:3001)
     ‚Üì HTTP Proxy
Main Nuxt App (server/index.ts:3000)
     ‚Üì WebSocket/HTTP
Browser Frontend
```

---

## üöÄ –ü–õ–ê–ù –†–ê–ó–í–ï–†–¢–´–í–ê–ù–ò–Ø

### **–®–ê–ì 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ**

```bash
# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh user@147.45.213.22

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤
cd /var/www/mapmon
ls -la ecosystem.config.cjs
ls -la server-backup/mqtt-collector.cjs
ls -la server-backup/api-server.cjs
ls -la server-backup/SQLiteManager.cjs
```

### **–®–ê–ì 2: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π**

```bash
# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è MQTT
npm install mqtt @fastify/cors

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
npm list mqtt
npm list @fastify/cors
```

### **–®–ê–ì 3: –ó–∞–ø—É—Å–∫ PM2 —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π**

```bash
# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
pm2 stop all
pm2 delete all

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ ecosystem.config.cjs —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
cat ecosystem.config.cjs

# –ó–∞–ø—É—Å–∫–∞–µ–º —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
pm2 start ecosystem.config.cjs

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
pm2 status
pm2 logs --lines 50
```

### **–®–ê–ì 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —Å–∏—Å—Ç–µ–º—ã**

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–ø–æ—Ä—Ç 3000)
curl http://localhost:3000/api/vehicles

# –ü—Ä–æ–≤–µ—Ä—è–µ–º API —Å–µ—Ä–≤–µ—Ä (–ø–æ—Ä—Ç 3001) 
curl http://localhost:3001/api/mqtt/status

# –ü—Ä–æ–≤–µ—Ä—è–µ–º MQTT endpoints —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
curl http://localhost:3000/api/mqtt/status

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏ MQTT –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞
pm2 logs mqtt-collector --lines 20
```

---

## üîß –ö–û–ú–ê–ù–î–´ –î–õ–Ø –°–ï–†–í–ï–†–ê

### **–ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ:**

```bash
#!/bin/bash
echo "üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π MQTT –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã..."

# –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/mapmon

# –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
git pull origin master

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
npm install

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º PM2 —Å –Ω–æ–≤–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π
pm2 stop all
pm2 delete all
pm2 start ecosystem.config.cjs

# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
sleep 5
pm2 status

# –ü—Ä–æ–≤–µ—Ä—è–µ–º API endpoints
echo "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ API endpoints..."
curl -s http://localhost:3000/api/mqtt/status | jq
curl -s http://localhost:3001/api/mqtt/status | jq

echo "‚úÖ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
```

### **–ö–æ–º–∞–Ω–¥—ã –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:**

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
netstat -tulnp | grep -E "(3000|3001|1883|8084)"

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ PM2
pm2 monit

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
pm2 logs --timestamp

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ MQTT
telnet o0acf6a7.ala.dedicated.gcp.emqxcloud.com 1883
```

---

## üîÑ –û–¢–ö–ê–¢ –ò–ó–ú–ï–ù–ï–ù–ò–ô

### **–ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞—Ç –¥–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è:**

```bash
#!/bin/bash
echo "üîô –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π MQTT –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã..."

# –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PM2
pm2 stop all
pm2 delete all

# –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º Git –∏–∑–º–µ–Ω–µ–Ω–∏—è
cd /var/www/mapmon
git checkout HEAD~5  # –û—Ç–∫–∞—Ç—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ 5 –∫–æ–º–º–∏—Ç–æ–≤

# –£–¥–∞–ª—è–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
rm -f ecosystem.config.cjs
rm -f MQTT_ARCHITECTURE_FIX.md

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—Ç–∞—Ä—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
npm run build
pm2 start "npm start" --name mapmon

echo "üîô –û—Ç–∫–∞—Ç –∑–∞–≤–µ—Ä—à–µ–Ω. –°–∏—Å—Ç–µ–º–∞ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏."
```

### **–ß–∞—Å—Ç–∏—á–Ω—ã–π –æ—Ç–∫–∞—Ç –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:**

```bash
# –û—Ç–∫–∞—Ç —Ç–æ–ª—å–∫–æ ecosystem.config.cjs
rm ecosystem.config.cjs

# –û—Ç–∫–∞—Ç —Ç–æ–ª—å–∫–æ server/index.ts
git checkout HEAD~1 server/index.ts

# –û—Ç–∫–∞—Ç MQTT –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞
git checkout HEAD~1 server-backup/mqtt-collector.cjs

# –û—Ç–∫–∞—Ç API —Å–µ—Ä–≤–µ—Ä–∞
git checkout HEAD~1 server-backup/api-server.cjs
```

---

## üìä –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –°–ò–°–¢–ï–ú–´

### **1. –¢–µ—Å—Ç MQTT –∫–æ–ª–ª–µ–∫—Ç–æ—Ä–∞:**

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
pm2 logs mqtt-collector | grep -E "(Connected|Error|üì°)"
```

### **2. –¢–µ—Å—Ç API endpoints:**

```bash
# –¢–µ—Å—Ç —Å—Ç–∞—Ç—É—Å–∞ MQTT
curl -X GET http://localhost:3000/api/mqtt/status

# –¢–µ—Å—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MQTT
curl -X POST http://localhost:3000/api/mqtt/config \
  -H "Content-Type: application/json" \
  -d '{"server":"test","port":1883}'

# –¢–µ—Å—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ MQTT
curl -X POST http://localhost:3000/api/mqtt/restart
```

### **3. –¢–µ—Å—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞:**

```bash
# –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –±—Ä–∞—É–∑–µ—Ä–µ
http://147.45.213.22

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∫–ª–∞–¥–∫—É "–ù–∞—Å—Ç—Ä–æ–π–∫–∏ MQTT"
# –î–æ–ª–∂–Ω–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –±–µ–∑ 404 –æ—à–∏–±–æ–∫
```

---

## ‚ö†Ô∏è –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–û–ë–õ–ï–ú–´ –ò –†–ï–®–ï–ù–ò–Ø

### **–ü—Ä–æ–±–ª–µ–º–∞: PM2 –Ω–µ –º–æ–∂–µ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å—ã**

```bash
# –†–µ—à–µ–Ω–∏–µ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
chmod +x server-backup/*.cjs
chown -R user:user /var/www/mapmon

# –†–µ—à–µ–Ω–∏–µ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≥–ª–æ–±–∞–ª—å–Ω–æ
npm install -g mqtt @fastify/cors

# –†–µ—à–µ–Ω–∏–µ 3: –ü–µ—Ä–µ—Å–æ–∑–¥–∞–µ–º ecosystem.config.cjs
rm ecosystem.config.cjs
# –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑ —ç—Ç–æ–π –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∑–∞–Ω–æ–≤–æ
```

### **–ü—Ä–æ–±–ª–µ–º–∞: MQTT –∫–æ–ª–ª–µ–∫—Ç–æ—Ä –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è**

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–µ—Ç–µ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
ping o0acf6a7.ala.dedicated.gcp.emqxcloud.com

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Ä—Ç—ã
telnet o0acf6a7.ala.dedicated.gcp.emqxcloud.com 8084

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–≥–∏
pm2 logs mqtt-collector --lines 100
```

### **–ü—Ä–æ–±–ª–µ–º–∞: API endpoints –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 404**

```bash
# –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ API —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω
pm2 status | grep api

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä—è–º–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ API —Å–µ—Ä–≤–µ—Ä—É
curl http://localhost:3001/api/mqtt/status

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ—Å—å —Å—Ç–µ–∫
pm2 restart all
```

---

## üìà –ú–û–ù–ò–¢–û–†–ò–ù–ì –°–ò–°–¢–ï–ú–´

### **–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:**

```bash
# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
watch -n 2 'pm2 status && echo "=== MQTT Status ===" && curl -s http://localhost:3000/api/mqtt/status | jq'

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ª–æ–≥–æ–≤
pm2 logs --timestamp --format

# –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ä–µ—Å—É—Ä—Å–æ–≤
pm2 monit
```

---

## ‚úÖ –ö–†–ò–¢–ï–†–ò–ò –£–°–ü–ï–•–ê

**–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –µ—Å–ª–∏:**

1. ‚úÖ PM2 –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 3 –ø—Ä–æ—Ü–µ—Å—Å–∞: `mapmon`, `mapmon-api`, `mqtt-collector`
2. ‚úÖ `/api/mqtt/status` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–π JSON –±–µ–∑ 404
3. ‚úÖ MQTT –∫–æ–ª–ª–µ–∫—Ç–æ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –±—Ä–æ–∫–µ—Ä—É –∏ –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ
4. ‚úÖ –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –±–µ–∑ –∫–æ–Ω—Å–æ–ª—å–Ω—ã—Ö –æ—à–∏–±–æ–∫
5. ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ MQTT –¥–æ—Å—Ç—É–ø–Ω—ã —á–µ—Ä–µ–∑ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

**–ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö —à–∞–≥–æ–≤ —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –≥–æ—Ç–æ–≤–∞ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é ESP32 —É—Å—Ç—Ä–æ–π—Å—Ç–≤!**

---

*üìÖ –°–æ–∑–¥–∞–Ω–æ: $(date)*  
*üë§ –í–µ—Ä—Å–∏—è: MapMon v0.5 MQTT Architecture Fix* 