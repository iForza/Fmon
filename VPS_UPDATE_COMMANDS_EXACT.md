# üöÄ –¢–æ—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è VPS —Å–µ—Ä–≤–µ—Ä–∞ MapMon

## üìç –î–∞–Ω–Ω—ã–µ —Å –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ VPS (2025-01-08)

**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞**: `/var/www/mapmon/`  
**–°—Ç–∞—Ç—É—Å**: –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ 3+ –¥–Ω—è  
**–ü—Ä–æ–±–ª–µ–º–∞**: Git –ù–ï –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞

---

## ‚ö†Ô∏è –í–ê–ñ–ù–û: Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!

–ù–∞ VPS –ø—Ä–æ–µ–∫—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ **git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω**. –°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å git.

---

## üîß –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ VPS

```bash
# –ü–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ VPS
ssh root@147.45.213.22

# –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø–∞–ø–∫—É –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/mapmon

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –ø–∞–ø–∫–∏
ls -la

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–π—Ç–µ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git init

# –î–æ–±–∞–≤—å—Ç–µ remote —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
git remote add origin https://github.com/iForza/Fmon.git

# –ü–æ–ª—É—á–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git fetch origin

# –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Ñ–∞–π–ª–æ–≤
git status
```

---

## üöÄ –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ backup –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ

```bash
# –°–û–ó–î–ê–ù–ò–ï BACKUP
cd /var/www/
BACKUP_NAME="mapmon-backup-$(date +%Y%m%d-%H%M%S)"
echo "–°–æ–∑–¥–∞–Ω–∏–µ backup: $BACKUP_NAME"
cp -r mapmon $BACKUP_NAME

# –û–°–¢–ê–ù–û–í–ö–ê –°–ï–†–í–ò–°–û–í
cd /var/www/mapmon
pm2 stop all
pm2 save

# –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê
# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π
git add .
git stash push -m "local-changes-before-update-$(date +%Y%m%d)"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
git pull origin master

# –£–°–¢–ê–ù–û–í–ö–ê –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô
npm ci

# –°–ë–û–†–ö–ê –ü–†–û–ï–ö–¢–ê  
npm run build

# –ó–ê–ü–£–°–ö –°–ï–†–í–ò–°–û–í
pm2 start ecosystem.config.cjs

# –ü–†–û–í–ï–†–ö–ê –°–¢–ê–¢–£–°–ê
sleep 5
pm2 status
```

---

## üîç –®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç–æ—Å–ø–æ—Å–æ–±–Ω–æ—Å—Ç–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2 –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
pm2 status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
curl -s http://localhost:3001/api/status

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Frontend  
curl -s -o /dev/null -w "%{http_code}" http://localhost:3000

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
pm2 logs --lines 10
```

---

## üõ†Ô∏è –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç (–µ—Å–ª–∏ git pull –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç)

–ï—Å–ª–∏ git pull –≤—ã–¥–∞–µ—Ç –æ—à–∏–±–∫–∏ –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤:

```bash
cd /var/www/mapmon

# –ñ–µ—Å—Ç–∫–∏–π —Å–±—Ä–æ—Å –∫ —É–¥–∞–ª–µ–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–∏
git fetch origin
git reset --hard origin/master

# –ò–ª–∏ –ø–æ–ª–Ω–∞—è –∑–∞–º–µ–Ω–∞ –ø—Ä–æ–µ–∫—Ç–∞
cd /var/www/
rm -rf mapmon-old 2>/dev/null
mv mapmon mapmon-old
git clone https://github.com/iForza/Fmon.git mapmon
cd mapmon

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏–∑ backup –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
cp ../mapmon-old/.env . 2>/dev/null || echo "No .env to restore"

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫
npm ci
npm run build
pm2 start ecosystem.config.cjs
```

---

## üìä –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

### PM2 Status –¥–æ–ª–∂–µ–Ω –ø–æ–∫–∞–∑–∞—Ç—å:
```
mapmon            ‚îÇ online ‚îÇ port 3000 ‚îÇ ~90-100MB
mapmon-api        ‚îÇ online ‚îÇ port 3001 ‚îÇ ~70-80MB  
mqtt-collector    ‚îÇ online ‚îÇ MQTT      ‚îÇ ~80-90MB
```

### API —Ç–µ—Å—Ç:
```bash
curl http://localhost:3001/api/status
# –û—Ç–≤–µ—Ç: {"status":"API Server running with SQLite"...}
```

### –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —É—Ç–µ—á–µ–∫ –ø–∞–º—è—Ç–∏):
- –ë—Ä–∞—É–∑–µ—Ä –Ω–µ –¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø—Ä–∏ –¥–ª–∏—Ç–µ–ª—å–Ω–æ–π —Ä–∞–±–æ—Ç–µ
- –í –ª–æ–≥–∞—Ö –¥–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏—è "üßπ –û—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤" –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- –°—Ç–∞–±–∏–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ frontend –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–æ–∫

---

## üö® –ü–ª–∞–Ω –æ—Ç–∫–∞—Ç–∞ (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫)

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–æ–≤
pm2 stop all

# –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ backup
cd /var/www/
rm -rf mapmon
mv mapmon-backup-[–¥–∞—Ç–∞] mapmon
cd mapmon

# –ó–∞–ø—É—Å–∫ —Å—Ç–∞—Ä–æ–π –≤–µ—Ä—Å–∏–∏
pm2 start ecosystem.config.cjs
pm2 status
```

---

## üîç –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º

### –ï—Å–ª–∏ PM2 –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è:
```bash
pm2 logs
pm2 restart all
pm2 reload ecosystem.config.cjs
```

### –ï—Å–ª–∏ API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
```bash
pm2 logs mapmon-api
ls -la server-backup/
node server-backup/api-server.cjs  # —Ç–µ—Å—Ç –∑–∞–ø—É—Å–∫–∞
```

### –ï—Å–ª–∏ Frontend –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç:
```bash
pm2 logs mapmon
ls -la .output/server/
npm run build  # –ø–µ—Ä–µ—Å–±–æ—Ä–∫–∞
```

---

## ‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

–ü–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

- [ ] `pm2 status` - –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã online
- [ ] `curl localhost:3001/api/status` - API —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] `curl localhost:3000` - Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç  
- [ ] –í–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –≤ –±—Ä–∞—É–∑–µ—Ä–µ
- [ ] ESP32 –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç—É–ø–∞—é—Ç –Ω–∞ –∫–∞—Ä—Ç—É
- [ ] –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫ –≤ `pm2 logs`
- [ ] –ü–∞–º—è—Ç—å –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ —Å—Ç–∞–±–∏–ª—å–Ω–∞ (–Ω–µ —Ä–∞—Å—Ç–µ—Ç)

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

1. **Git config**: –í–æ–∑–º–æ–∂–Ω–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å git config user
2. **–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**: –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –ë–î –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å (–Ω–µ –≤ server-backup/)
3. **MQTT –æ—à–∏–±–∫–∏**: Timeout –æ—à–∏–±–∫–∏ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
4. **SSR –æ—à–∏–±–∫–∏**: pages/history.vue:86 - –±—É–¥—É—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏

**–í—Ä–µ–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è**: ~10-15 –º–∏–Ω—É—Ç –ø—Ä–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ–º –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ.