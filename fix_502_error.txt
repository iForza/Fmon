# üö® –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –û–®–ò–ë–ö–ò 502 BAD GATEWAY

## –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø—Ä–æ–±–ª–µ–º—ã:

# 1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É
ssh root@147.45.213.22

# 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ PM2
pm2 status

# 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ PM2
pm2 logs mapmon --lines 20

# 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Ä—Ç–æ–≤
sudo netstat -tlnp | grep :3000

# 5. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ Node.js
ps aux | grep node

# 6. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤ Nginx
sudo tail -20 /var/log/nginx/error.log
sudo tail -20 /var/log/nginx/mapmon.error.log

## –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã –∏ —Ä–µ—à–µ–Ω–∏—è:

### –ü–†–ò–ß–ò–ù–ê 1: PM2 –ø—Ä–æ—Ü–µ—Å—Å –Ω–µ –∑–∞–ø—É—â–µ–Ω –∏–ª–∏ —É–ø–∞–ª
# –†–µ—à–µ–Ω–∏–µ:
cd /var/www/mapmon
pm2 delete mapmon
pm2 start ecosystem.config.js
pm2 save

### –ü–†–ò–ß–ò–ù–ê 2: –û—à–∏–±–∫–∞ —Å–±–æ—Ä–∫–∏ Nuxt
# –†–µ—à–µ–Ω–∏–µ:
cd /var/www/mapmon
rm -rf .nuxt .output node_modules
yarn install
yarn build
pm2 restart mapmon

### –ü–†–ò–ß–ò–ù–ê 3: –ü–æ—Ä—Ç 3000 –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –ø—Ä–æ—Ü–µ—Å—Å–æ–º
# –ü—Ä–æ–≤–µ—Ä–∫–∞:
sudo lsof -i :3000
# –ï—Å–ª–∏ –µ—Å—Ç—å –¥—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å - —É–±–∏—Ç—å –µ–≥–æ:
sudo kill -9 <PID>

### –ü–†–ò–ß–ò–ù–ê 4: –ü—Ä–æ–±–ª–µ–º—ã —Å –ø—Ä–∞–≤–∞–º–∏ –¥–æ—Å—Ç—É–ø–∞
# –†–µ—à–µ–Ω–∏–µ:
cd /var/www/mapmon
sudo chown -R root:root .
chmod -R 755 .

### –ü–†–ò–ß–ò–ù–ê 5: Nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
# –ü—Ä–æ–≤–µ—Ä–∫–∞:
sudo nginx -t
sudo systemctl reload nginx

## –ü–û–õ–ù–û–ï –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï (–µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç):

# 1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ
pm2 stop all
sudo systemctl stop nginx

# 2. –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ
cd /var/www/mapmon
rm -rf .nuxt .output node_modules

# 3. –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
yarn install

# 4. –ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
yarn build

# 5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å ecosystem.config.js
cat ecosystem.config.js

# 6. –ó–∞–ø—É—Å—Ç–∏—Ç—å PM2
pm2 start ecosystem.config.js
pm2 save

# 7. –ó–∞–ø—É—Å—Ç–∏—Ç—å Nginx
sudo systemctl start nginx

# 8. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å
pm2 status
sudo systemctl status nginx

# 9. –¢–µ—Å—Ç
curl -I http://127.0.0.1:3000
curl -I https://fleetmonitor.ru

## –≠–ö–°–¢–†–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï - –æ—Ç–∫–∞—Ç –∫ —Ä–∞–±–æ—á–µ–π –≤–µ—Ä—Å–∏–∏:

# –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç, –æ—Ç–∫–∞—Ç—ã–≤–∞–µ–º—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–º–º–∏—Ç—É:
cd /var/www/mapmon
git log --oneline -5
git reset --hard 418b92c  # –ü—Ä–µ–¥—ã–¥—É—â–∏–π —Ä–∞–±–æ—á–∏–π –∫–æ–º–º–∏—Ç
rm -rf .nuxt .output
yarn build
pm2 restart mapmon 