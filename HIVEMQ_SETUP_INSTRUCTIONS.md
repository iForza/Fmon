# üöÄ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–µ—Ä–µ—Ö–æ–¥—É –Ω–∞ HiveMQ

## ‚úÖ –ß—Ç–æ —É–∂–µ —Å–¥–µ–ª–∞–Ω–æ:

### 1. **–°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π ESP32 —Å–∫–µ—Ç—á**: `esp32/hivemq_fleet_tracker.ino`
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ `broker.hivemq.com:1883`
- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö
- –ë–æ–ª–µ–µ –Ω–∞–¥–µ–∂–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ WiFi
- –¢–æ–ø–∏–∫–∏ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `mapmon/` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤

### 2. **–û–±–Ω–æ–≤–ª–µ–Ω MQTT collector**: `server-backup/mqtt-collector.cjs`
- –ò–∑–º–µ–Ω–µ–Ω –±—Ä–æ–∫–µ—Ä —Å `test.mosquitto.org` –Ω–∞ `broker.hivemq.com`
- –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ (keepalive, reconnectPeriod, connectTimeout)
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–æ–≤—ã—Ö —Ç–æ–ø–∏–∫–æ–≤ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º `mapmon/`
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –æ–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º–∏ —Ç–æ–ø–∏–∫–∞–º–∏

## üîß –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

### **–®–∞–≥ 1: –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–π —Å–∫–µ—Ç—á –Ω–∞ ESP32**
```arduino
// –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª: esp32/hivemq_fleet_tracker.ino
// –í Arduino IDE:
// 1. –û—Ç–∫—Ä–æ–π—Ç–µ hivemq_fleet_tracker.ino
// 2. –£–∫–∞–∂–∏—Ç–µ –≤–∞—à–∏ WiFi –¥–∞–Ω–Ω—ã–µ:
const char* ssid = "–í–ê–®_WIFI";
const char* password = "–í–ê–®_–ü–ê–†–û–õ–¨";
// 3. –ó–∞–≥—Ä—É–∑–∏—Ç–µ –Ω–∞ ESP32
```

### **–®–∞–≥ 2: –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å MQTT collector –Ω–∞ VPS**
```bash
# –ù–∞ VPS:
cd /var/www/mapmon
pm2 stop mqtt-collector
pm2 start mqtt-collector
pm2 logs mqtt-collector --lines 50
```

### **–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ**
```bash
# –î–æ–ª–∂–Ω—ã —É–≤–∏–¥–µ—Ç—å –≤ –ª–æ–≥–∞—Ö:
# ‚úÖ MQTT Connected - HiveMQ
# üì° Subscribed to all ESP32 topics (HiveMQ + legacy)
```

## üîç **–û—Å–Ω–æ–≤–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è**:

### **ESP32 —Å–∫–µ—Ç—á:**
- ‚úÖ **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å**: –£–ª—É—á—à–µ–Ω–Ω–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ WiFi –∏ MQTT
- ‚úÖ **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ —Å —ç–º–æ–¥–∑–∏ –¥–ª—è –ª–µ–≥–∫–æ–≥–æ —á—Ç–µ–Ω–∏—è
- ‚úÖ **–ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å**: Watchdog –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞–≤–∏—Å–∞–Ω–∏—è
- ‚úÖ **–¢–æ–ø–∏–∫–∏**: –ü—Ä–µ—Ñ–∏–∫—Å `mapmon/` –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ –Ω–∞ –ø—É–±–ª–∏—á–Ω–æ–º –±—Ä–æ–∫–µ—Ä–µ
- ‚úÖ **–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã**: –¢–µ–ª–µ–º–µ—Ç—Ä–∏—è –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫, heartbeat –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫

### **MQTT Collector:**
- ‚úÖ **HiveMQ**: –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –±–æ–ª–µ–µ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π –±—Ä–æ–∫–µ—Ä
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Å—Ç–∞—Ä—ã—Ö –∏ –Ω–æ–≤—ã—Ö —Ç–æ–ø–∏–∫–æ–≤
- ‚úÖ **–ù–∞—Å—Ç—Ä–æ–π–∫–∏**: –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### **–ù–æ–≤—ã–µ —Ç–æ–ø–∏–∫–∏ (—Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º mapmon/):**
- `mapmon/vehicles/ESP32_Car_2046/telemetry` - —Ç–µ–ª–µ–º–µ—Ç—Ä–∏—è
- `mapmon/vehicles/ESP32_Car_2046/status` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- `mapmon/vehicles/ESP32_Car_2046/heartbeat` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏
- `mapmon/vehicles/ESP32_Car_2046/commands` - –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É

## üêõ **–†–µ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã**:

1. **–°—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å MQTT**: HiveMQ –±–æ–ª–µ–µ –Ω–∞–¥–µ–∂–µ–Ω —á–µ–º test.mosquitto.org
2. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Ç–æ–ø–∏–∫–æ–≤**: –ü—Ä–µ—Ñ–∏–∫—Å `mapmon/` –∏–∑–æ–ª–∏—Ä—É–µ—Ç –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
3. **–ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**: –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
4. **–î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞**: –ü–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

## üìä **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**:

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ ESP32:**
```arduino
// –í Serial Monitor –¥–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
// üìä [123] –¢–ï–õ–ï–ú–ï–¢–†–ò–Ø ‚Üí HiveMQ
// üìç 55.75580, 37.61760 | üèÉ 15.2 –∫–º/—á | üîã 84.5% | üå°Ô∏è 23.1¬∞C | active
// üíì HEARTBEAT ‚Üí HiveMQ (uptime: 245s, msg: 49)
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ VPS:**
```bash
pm2 logs mqtt-collector --lines 20
# –î–æ–ª–∂–Ω—ã –≤–∏–¥–µ—Ç—å:
# üì° MQTT Received topic: mapmon/vehicles/ESP32_Car_2046/telemetry
# üíæ SAVED TO SQLITE - ID: 12345
```

### **–ü—Ä–æ–≤–µ—Ä–∫–∞ API:**
```bash
curl -s http://localhost:3001/api/vehicles | jq
curl -s http://localhost:3001/api/telemetry/latest | jq
```

## üÜò **Troubleshooting**:

### **–ï—Å–ª–∏ ESP32 –Ω–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ WiFi –¥–∞–Ω–Ω—ã–µ
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ Serial Monitor (115200 baud)
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ WiFi —Ä–∞–±–æ—Ç–∞–µ—Ç

### **–ï—Å–ª–∏ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç –¥–∞–Ω–Ω—ã–µ –Ω–∞ VPS:**
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ MQTT collector: `pm2 logs mqtt-collector`
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ collector –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ HiveMQ
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ ESP32 –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Serial Monitor

### **–ï—Å–ª–∏ –ø–∞–Ω–µ–ª—å –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞:**
1. –°–Ω–∞—á–∞–ª–∞ —Ä–µ—à–∏—Ç–µ race conditions (–∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞)
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ API –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ: `curl http://localhost:3001/api/vehicles`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –ø–æ—Ä–æ–≥–∏ –≤ useVehicleManager.ts

## üîÑ **–û—Ç–∫–∞—Ç –Ω–∞–∑–∞–¥** (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫):
```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –Ω–æ–≤—ã–π collector
pm2 stop mqtt-collector

# –í–µ—Ä–Ω—É—Ç—å —Å—Ç–∞—Ä—ã–π –∫–æ–¥
git checkout HEAD -- server-backup/mqtt-collector.cjs

# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–π collector
pm2 start mqtt-collector
```

## üìù **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ**:

### **–î–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è:**
1. **HiveMQ Cloud** (–ø–ª–∞—Ç–Ω—ã–π –ø–ª–∞–Ω) –¥–ª—è –ª—É—á—à–µ–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
2. **TLS —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ** (–ø–æ—Ä—Ç 8883) 
3. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** —Å username/password
4. **Retained messages** –¥–ª—è –≤–∞–∂–Ω—ã—Ö —Å—Ç–∞—Ç—É—Å–æ–≤

### **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ TLS** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ):
–í ESP32 —Å–∫–µ—Ç—á–µ —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ:
```arduino
WiFiClientSecure espClientSecure;
espClientSecure.setInsecure();
client.setClient(espClientSecure);
client.setServer(mqtt_server, 8883);
```